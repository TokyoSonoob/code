<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Purple Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
<style>
  :root{--bg1:#070313;--bg2:#0a0620;--bg3:#0f0a2a;--text:#e8e8ff}
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);font-family:'Prompt',system-ui,Segoe UI,Roboto,'Noto Sans Thai',sans-serif;
    background:
      radial-gradient(1200px 700px at -15% -10%, rgba(139,92,246,.22), transparent 60%),
      radial-gradient(1000px 600px at 115% 10%, rgba(96,165,250,.20), transparent 65%),
      radial-gradient(800px 500px at 50% 120%, rgba(79,70,229,.16), transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2) 42%,var(--bg3));
    overflow:hidden;
  }
  /* particle + side glow */
  #fx{position:fixed;inset:0;z-index:0;pointer-events:none;filter:blur(.4px) brightness(1.1) saturate(1.2)}
  .frame:before,.frame:after{
    content:"";position:fixed;top:0;bottom:0;width:18px;pointer-events:none;filter:blur(1px);
    background:linear-gradient(180deg,transparent,rgba(167,139,250,.55),rgba(96,165,250,.55),transparent);
    animation:glow 3.6s ease-in-out infinite;z-index:1}
  .frame:before{left:22px}.frame:after{right:22px;animation-delay:1.1s}
  @keyframes glow{0%,100%{opacity:.35}50%{opacity:.9}}

  /* layout: title on top, button centered */
  header.top{position:relative;z-index:2;text-align:center;padding:28px 16px 10px}
  h1{
    margin:0;font-size:clamp(40px,8vw,90px);font-weight:800;letter-spacing:.4px;line-height:1.02;
    background:linear-gradient(90deg,#7c3aed 0%,#b794f4 38%,#ffffff 50%,#93c5fd 62%,#7c3aed 100%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 10px 40px rgba(99,102,241,.45);filter:drop-shadow(0 10px 28px rgba(124,58,237,.35));
  }
  main.center{
    position:relative;z-index:2;display:grid;place-items:center;
    min-height:calc(100vh - 120px);
    padding:10px 16px 40px;
  }

  /* button (medium, gradient like sample) */
  #big{
    position:relative;cursor:pointer;user-select:none;outline:none;
    display:inline-flex;align-items:center;justify-content:center;gap:12px;
    min-width:320px;max-width:92vw;height:72px;padding:0 28px;border-radius:18px;
    background:linear-gradient(90deg,#6d28d9 0%, #3b82f6 100%);color:#fff;font-weight:800;
    font-size:clamp(16px,2.6vw,20px);letter-spacing:.2px;border:1px solid rgba(167,139,250,.45);
    box-shadow:0 14px 36px rgba(59,130,246,.35),inset 0 0 0 1px rgba(255,255,255,.06),0 0 80px rgba(124,58,237,.18);
    transition:transform .12s ease, box-shadow .25s ease, border-color .2s ease, background .25s ease;
  }
  #big:hover{transform:translateY(-2px);box-shadow:0 18px 48px rgba(59,130,246,.45),inset 0 0 0 1px rgba(255,255,255,.08)}
  #big:active{transform:translateY(0) scale(.985)}
  #big.drag{border-color:#a78bfa;box-shadow:0 20px 56px rgba(124,58,237,.5),inset 0 0 0 1px rgba(255,255,255,.1)}
  #big svg{filter:drop-shadow(0 2px 8px rgba(255,255,255,.25))}
  .status{position:absolute;bottom:-26px;left:50%;transform:translateX(-50%);font-size:13px;opacity:.9}
  .spin{width:20px;height:20px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite;vertical-align:-4px;display:inline-block;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Fade overlay */
  .fadecover{position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;z-index:40;transition:opacity .35s ease}
  .fadecover.show{opacity:.85;pointer-events:auto}
  .fadecover.hide{opacity:0;pointer-events:none;transition:opacity .5s ease}

  /* Modal (no title bar) — two neon boxes */
  .modal{position:fixed;inset:0;display:none;place-items:center;z-index:41}
  .modal.open{display:grid}
  .panel{width:min(1100px,96vw);background:transparent;transform:scale(.96);opacity:0;animation:pop .28s ease-out .05s forwards}
  @keyframes pop{to{transform:scale(1);opacity:1}}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

  .neon{
    position:relative;border-radius:20px;padding:14px;
    background:linear-gradient(180deg, rgba(15,10,40,.9), rgba(10,8,28,.9));
    border:1px solid rgba(167,139,250,.6);
    box-shadow:
      0 0 0 1px rgba(255,255,255,.08) inset,
      0 24px 100px rgba(124,58,237,.65),
      0 0 140px rgba(96,165,250,.65),
      0 0 80px rgba(167,139,250,.55);
    overflow:hidden;
  }
  .neon:before{
    content:""; position:absolute; inset:-2px; border-radius:22px;
    background:conic-gradient(from 0deg, rgba(139,92,246,.55), rgba(96,165,250,.55), rgba(139,92,246,.55));
    filter:blur(28px); opacity:.7; z-index:-1; animation:spin 6s linear infinite;
  }
  pre{
    margin:0;padding:14px 16px;background:#0b0a18;border:1px solid #231f3e;border-radius:14px;color:#e6f3ff;
    font:13px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;min-height:160px;
    box-shadow:inset 0 0 28px rgba(20,20,48,.65);
  }
  .btnbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;color:#fff;background:linear-gradient(135deg,#7c3aed,#3b82f6);cursor:pointer;box-shadow:0 10px 36px rgba(99,102,241,.35)}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="frame"></div>

<header class="top"><h1>Purple Shop</h1></header>

<main class="center">
  <button id="big" title="เลือกไฟล์หรือวางไฟล์บนปุ่มนี้">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
    เลือกไฟล์ / ลากมาวาง
    <div id="status" class="status"></div>
    <input id="file" type="file" multiple hidden accept=".zip,.mcpack,.mcaddon,.json,application/zip,application/json">
  </button>
</main>

<!-- Fade overlay -->
<div id="fade" class="fadecover"></div>

<!-- Popup (no title text) -->
<div id="modal" class="modal">
  <div class="panel">
    <div class="grid">
      <section class="neon">
        <pre><code id="outRS">[]</code></pre>
        <div class="btnbar"><button class="btn" id="copyRS">คัดลอก RS</button></div>
      </section>
      <section class="neon">
        <pre><code id="outBH">[]</code></pre>
        <div class="btnbar"><button class="btn" id="copyBH">คัดลอก BH</button></div>
      </section>
    </div>
    <div class="btnbar" style="margin-top:14px"><button class="btn" id="close">ปิด</button></div>
  </div>
</div>

<script>
/* particles */
(() => {
  const c = document.getElementById('fx'), ctx = c.getContext('2d');
  let w=innerWidth,h=innerHeight; c.width=w;c.height=h;
  const dots = Array.from({length:120},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.8+0.6,vx:(Math.random()-.5)*0.2,vy:(Math.random()-.5)*0.2,hue:Math.random()<.5?265:210}));
  function step(){ ctx.clearRect(0,0,w,h); for(const p of dots){ p.x+=p.vx;p.y+=p.vy; if(p.x<0||p.x>w)p.vx*=-1; if(p.y<0||p.y>h)p.vy*=-1; ctx.beginPath(); ctx.fillStyle=`hsla(${p.hue},80%,70%,.7)`; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); } requestAnimationFrame(step) }
  step(); addEventListener('resize',()=>{w=innerWidth;h=innerHeight;c.width=w;c.height=h;});
})();

/* core */
const big=document.getElementById('big'), file=document.getElementById('file'), statusEl=document.getElementById('status');
const modal=document.getElementById('modal'), fade=document.getElementById('fade');
const outRS=document.getElementById('outRS'), outBH=document.getElementById('outBH');
const copyRS=document.getElementById('copyRS'), copyBH=document.getElementById('copyBH'), closeBtn=document.getElementById('close');

/* คงค่าไว้ อัปต่อได้เรื่อย ๆ */
const RS=new Map(), BH=new Map();

big.addEventListener('click',()=>file.click());
['dragenter','dragover'].forEach(ev=>big.addEventListener(ev,e=>{e.preventDefault();big.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>big.addEventListener(ev,e=>{e.preventDefault();big.classList.remove('drag');}));
big.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
file.onchange=()=>handleFiles(file.files);

function isZipLike(n,t){n=(n||'').toLowerCase();return t==='application/zip'||/\.(zip|mcpack|mcaddon)$/.test(n)}
function setLoading(on){statusEl.innerHTML=on?'<span class="spin"></span>กำลังประมวลผล…':''}

/* RS rule: zip มีโฟลเดอร์ textures (ภายใต้โฟลเดอร์เดียวกับ manifest) */
function hasTexturesInZip(zip, manifestPath){
  const base = manifestPath.includes('/') ? manifestPath.split('/').slice(0,-1).join('/')+'/' : '';
  const re = new RegExp('^'+base.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'textures/','i');
  return Object.keys(zip.files).some(name => re.test(name));
}

async function handleFiles(list){
  const files=Array.from(list||[]); if(!files.length) return;

  // fade ดำเข้า
  fade.className='fadecover show';
  await new Promise(r=>setTimeout(r,180));

  setLoading(true);

  for(const f of files){
    try{
      if(/manifest\.json$/i.test(f.name)){
        // ไฟล์ manifest เดี่ยว → จัด BH (เพราะเช็ค textures ไม่ได้)
        const t=await f.text(); await handleManifest(await parseManifestText(t), false);
      }else if(isZipLike(f.name,f.type)){
        const zip=await JSZip.loadAsync(f);
        const ent=Object.values(zip.files).find(x=>/(^|\/)manifest\.json$/i.test(x.name));
        if(!ent) continue;
        const text=await ent.async('text');
        const isRS = hasTexturesInZip(zip, ent.name);
        await handleManifest(await parseManifestText(text), isRS);
      }
    }catch{}
  }

  setLoading(false);

  // fade ออก แล้วเปิดป๊อปอัพ
  fade.className='fadecover hide';
  setTimeout(()=>{ fade.className='fadecover'; openModal(); }, 340);
}

async function parseManifestText(text){
  try{return JSON.parse(text);}catch{
    try{
      const fixed=text.replace(/^\s*"|"\s*$/g,'').replace(/\\n/g,'\\n');
      return JSON.parse(JSON.parse('"'+fixed.replace(/"/g,'\\"')+'"'));
    }catch{ return {}; }
  }
}

async function handleManifest(obj, isRS){
  const h=obj?.header||{}; const uuid=h.uuid||h.pack_id; const ver=h.version||h.pack_version;
  if(!uuid||!ver) return;
  const pack_id=String(uuid);
  const version=Array.isArray(ver)?ver.map(Number):String(ver).split('.').map(Number);

  // อัปซ้ำจะทับค่าเดิม (ตาม pack_id)
  if(isRS) RS.set(pack_id,{pack_id,version});
  else     BH.set(pack_id,{pack_id,version});
}

function buildJSON(){
  const sort=a=>a.sort((x,y)=>{
    const ax=x.version||[], ay=y.version||[];
    for(let i=0;i<Math.max(ax.length,ay.length);i++){ const d=(ay[i]??0)-(ax[i]??0); if(d) return d; }
    return x.pack_id.localeCompare(y.pack_id);
  });
  const rs=sort(Array.from(RS.values())).map(({pack_id,version})=>({pack_id,version}));
  const bh=sort(Array.from(BH.values())).map(({pack_id,version})=>({pack_id,version}));
  return {rs:JSON.stringify(rs,null,2), bh:JSON.stringify(bh,null,2)};
}

/* type-out */
async function typeOut(el,text){el.textContent='';const d=5;for(let i=0;i<text.length;i++){el.textContent+=text[i];if(i%3===0) await new Promise(r=>setTimeout(r,d));}}
function openModal(){const {rs,bh}=buildJSON(); document.getElementById('modal').classList.add('open'); typeOut(outRS,rs); typeOut(outBH,bh);}
closeBtn.onclick=()=>modal.classList.remove('open');

/* copy */
async function copy(t){try{await navigator.clipboard.writeText(t);}catch{}}
copyRS.onclick=()=>copy(outRS.textContent);
copyBH.onclick=()=>copy(outBH.textContent);
</script>
</body>
</html>
