<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Purple Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
<style>
  :root{--bg1:#070313;--bg2:#0a0620;--bg3:#0f0a2a;--text:#e8e8ff}
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);font-family:'Prompt',system-ui,Segoe UI,Roboto,'Noto Sans Thai',sans-serif;
    background:
      radial-gradient(1200px 700px at -15% -10%, rgba(139,92,246,.22), transparent 60%),
      radial-gradient(1000px 600px at 115% 10%, rgba(96,165,250,.20), transparent 65%),
      radial-gradient(800px 500px at 50% 120%, rgba(79,70,229,.16), transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2) 42%,var(--bg3));
    overflow:hidden;
  }
  #fx{position:fixed;inset:0;z-index:0;pointer-events:none;filter:blur(.4px) brightness(1.1) saturate(1.2)}
  .frame:before,.frame:after{
    content:"";position:fixed;top:0;bottom:0;width:18px;pointer-events:none;filter:blur(1px);
    background:linear-gradient(180deg,transparent,rgba(167,139,250,.55),rgba(96,165,250,.55),transparent);
    animation:glow 3.6s ease-in-out infinite;z-index:1}
  .frame:before{left:22px}.frame:after{right:22px;animation-delay:1.1s}
  @keyframes glow{0%,100%{opacity:.35}50%{opacity:.9}}

  header.top{position:relative;z-index:2;text-align:center;padding:28px 16px 10px}
  h1{
    margin:0;font-size:clamp(40px,8vw,90px);font-weight:800;letter-spacing:.4px;line-height:1.02;
    background:linear-gradient(90deg,#7c3aed 0%,#b794f4 38%,#ffffff 50%,#93c5fd 62%,#7c3aed 100%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 10px 40px rgba(99,102,241,.45);filter:drop-shadow(0 10px 28px rgba(124,58,237,.35));
  }

  main.center{
    position:relative;z-index:2;display:grid;place-items:center;
    min-height:calc(100vh - 120px);
    padding:10px 16px 40px;
    grid-template-rows:auto auto auto;
    gap:14px;
  }

  /* ===== Uploads gallery ===== */
  #uploads{
    width:min(1200px,95vw);
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:200px;
    gap:12px;
    overflow:auto hidden;
    padding:10px;                          /* เพิ่มพื้นหลัง/ขอบกลบแสงซ้ายให้เหมือนขวา */
    background:linear-gradient(180deg, rgba(12,10,28,.85), rgba(10,8,26,.85));
    border:1px solid rgba(167,139,250,.18);
    border-radius:18px;
    box-shadow:0 12px 60px rgba(124,58,237,.25), inset 0 0 0 1px rgba(255,255,255,.05);
    scrollbar-gutter:stable;
  }
  #uploads .card{
    position:relative;
    border-radius:16px;
    background:linear-gradient(180deg, rgba(15,10,40,.9), rgba(10,8,28,.9));
    border:1px solid rgba(167,139,250,.35);
    box-shadow:0 0 0 1px rgba(255,255,255,.06) inset,0 18px 60px rgba(124,58,237,.35),0 0 70px rgba(96,165,250,.35);
    overflow:hidden;
    display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  }
  #uploads .thumb{
    width:100%;height:150px;object-fit:cover;background:#0b0a18;border-bottom:1px solid #231f3e
  }
  #uploads .name{
    width:100%;
    padding:8px 10px 12px;
    font-size:13px;font-weight:800;letter-spacing:.2px;text-align:center;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    background:none;
  }

  /* === ปุ่มลบการ์ด X มุมขวาบน === */
  #uploads .del{
    position:absolute;top:6px;right:6px;
    width:28px;height:28px;border-radius:9999px;
    border:1px solid rgba(255,255,255,.25);
    background:linear-gradient(135deg,#ef4444,#dc2626);
    color:#fff;font-weight:800;display:grid;place-items:center;line-height:1;
    box-shadow:0 6px 18px rgba(239,68,68,.45), inset 0 0 0 1px rgba(255,255,255,.06);
    cursor:pointer;transition:transform .12s ease, box-shadow .2s ease, opacity .2s ease;
  }
  #uploads .del:hover{transform:scale(1.05)}
  #uploads .del:active{transform:scale(.96)}
  #uploads .del span{font-size:18px;transform:translateY(-1px)}

  #uploads::-webkit-scrollbar{height:10px}
  #uploads::-webkit-scrollbar-thumb{background:#2a2750;border-radius:10px}
  #uploads::-webkit-scrollbar-track{background:#131129;border-radius:10px}

  /* file bar */
  .filebar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center}

  /* ปุ่มหลัก */
  #big{
    position:relative;cursor:pointer;user-select:none;outline:none;
    display:inline-flex;align-items:center;justify-content:center;gap:12px;
    min-width:320px;max-width:92vw;height:72px;padding:0 28px;border-radius:18px;
    background:linear-gradient(90deg,#6d28d9 0%, #3b82f6 100%);color:#fff;font-weight:800;
    font-size:clamp(16px,2.6vw,20px);letter-spacing:.2px;border:1px solid rgba(167,139,250,.45);
    box-shadow:0 14px 36px rgba(59,130,246,.35),inset 0 0 0 1px rgba(255,255,255,.06),0 0 80px rgba(124,58,237,.18);
    transition:transform .12s ease, box-shadow .25s ease, border-color .2s ease, background .25s ease;
  }
  #big:hover{transform:translateY(-2px);box-shadow:0 18px 48px rgba(59,130,246,.45),inset 0 0 0 1px rgba(255,255,255,.08)}
  #big:active{transform:translateY(0) scale(.985)}
  #big.drag{border-color:#a78bfa;box-shadow:0 20px 56px rgba(124,58,237,.5),inset 0 0 0 1px rgba(255,255,255,.1)}
  #big svg{filter:drop-shadow(0 2px 8px rgba(255,255,255,.25))}
  .status{position:absolute;bottom:-26px;left:50%;transform:translateX(-50%);font-size:13px;opacity:.9}

  /* ปุ่มทั่วไป */
  .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;color:#fff;background:linear-gradient(135deg,#7c3aed,#3b82f6);cursor:pointer;box-shadow:0 10px 36px rgba(99,102,241,.35)}
  #clearFiles{background:linear-gradient(135deg,#9333ea,#2563eb)}
  #showUUID{background:linear-gradient(135deg,#8b5cf6,#60a5fa)}

  .spin{width:20px;height:20px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite;vertical-align:-4px;display:inline-block;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .fadecover{position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;z-index:40;transition:opacity .35s ease}
  .fadecover.show{opacity:.85;pointer-events:auto}
  .fadecover.hide{opacity:0;pointer-events:none;transition:opacity .5s ease}
  .modal{position:fixed;inset:0;display:none;place-items:center;z-index:41}
  .modal.open{display:grid}
  .panel{width:min(1100px,96vw);background:transparent;transform:scale(.96);opacity:0;animation:pop .28s ease-out .05s forwards}
  @keyframes pop{to{transform:scale(1);opacity:1}}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .neon{
    position:relative;border-radius:20px;padding:14px;
    background:linear-gradient(180deg, rgba(15,10,40,.9), rgba(10,8,28,.9));
    border:1px solid rgba(167,139,250,.6);
    box-shadow:0 0 0 1px rgba(255,255,255,.08) inset,0 24px 100px rgba(124,58,237,.65),0 0 140px rgba(96,165,250,.65),0 0 80px rgba(167,139,250,.55);
    overflow:hidden;
  }
  .neon:before{
    content:""; position:absolute; inset:-2px; border-radius:22px;
    background:conic-gradient(from 0deg, rgba(139,92,246,.55), rgba(96,165,250,.55), rgba(139,92,246,.55));
    filter:blur(28px); opacity:.7; z-index:-1; animation:spin 6s linear infinite;
  }
  pre{
    margin:0;
    padding:14px 16px;
    background:#0b0a18;
    border:1px solid #231f3e;
    border-radius:14px;
    color:#e6f3ff;
    font:13px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    min-height:160px;
    max-height:46vh;
    overflow:auto;
    white-space:pre;
    tab-size:2;
    scrollbar-gutter: stable both-edges;
    box-shadow:inset 0 0 28px rgba(20,20,48,.65);
  }
  pre::-webkit-scrollbar{height:10px;width:10px}
  pre::-webkit-scrollbar-thumb{background:#2a2750;border-radius:10px}
  pre::-webkit-scrollbar-track{background:#131129;border-radius:10px}
  .btnbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

  /* ===== Mobile tweaks ===== */
  @media (max-width: 640px){
    body{ overflow:auto; } /* ให้เลื่อนหน้าได้บนจอเล็ก */
    #uploads{ grid-auto-columns:150px; gap:10px; padding:8px; }
    #uploads .thumb{ height:120px; }
    #uploads .name{ font-size:12px; padding:6px 8px 10px; }
    #uploads .del{ width:30px; height:30px; top:5px; right:5px; }
    #big{ width:100%; min-width:unset; height:64px; }
    .status{ bottom:-22px; font-size:12px; }
    .neon{ padding:12px; border-radius:16px; }
    pre{ font-size:12px; max-height:50vh; }
    .panel{ width:96vw; }
    .grid{ grid-template-columns:1fr; } /* modal แสดงซ้อนลงมาเป็นคอลัมน์เดียว */
  }
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="frame"></div>

<header class="top"><h1>Purple Shop</h1></header>

<main class="center">
  <!-- แกลเลอรี่ไฟล์ที่อัปโหลด -->
  <div id="uploads" aria-label="ไฟล์ที่อัปโหลด"></div>

  <!-- ปุ่ม โชว์ UUID / เลือกไฟล์ / ล้างไฟล์ -->
  <div class="filebar">
    <button id="showUUID" class="btn" title="แสดงรายการ UUID">โชว์ UUID</button>

    <button id="big" title="เลือกไฟล์หรือวางไฟล์บนปุ่มนี้">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      เลือกไฟล์ / ลากมาวาง
      <div id="status" class="status"></div>
      <input id="file" type="file" multiple hidden accept=".zip,.mcpack,.mcaddon,.json,application/zip,application/json">
    </button>

    <button id="clearFiles" class="btn">ล้างไฟล์</button>
  </div>
</main>

<div id="fade" class="fadecover"></div>

<div id="modal" class="modal">
  <div class="panel">
    <div class="grid">
      <section class="neon">
        <pre><code id="outRS">[]</code></pre>
        <div class="btnbar"><button class="btn" id="copyRS">คัดลอก RS</button></div>
      </section>
      <section class="neon">
        <pre><code id="outBH">[]</code></pre>
        <div class="btnbar"><button class="btn" id="copyBH">คัดลอก BH</button></div>
      </section>
    </div>
    <div class="btnbar" style="margin-top:14px">
      <button class="btn" id="reset">ล้างรายการ</button>
      <button class="btn" id="close">ปิด</button>
    </div>
  </div>
</div>

<script>
/* particles */
(() => {
  const c = document.getElementById('fx'), ctx = c.getContext('2d');
  let w=innerWidth,h=innerHeight; c.width=w;c.height=h;
  const dots = Array.from({length:120},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.8+0.6,vx:(Math.random()-.5)*0.2,vy:(Math.random()-.5)*0.2,hue:Math.random()<.5?265:210}));
  function step(){ ctx.clearRect(0,0,w,h);
    for(const p of dots){ p.x+=p.vx;p.y+=p.vy; if(p.x<0||p.x>w)p.vx*=-1; if(p.y<0||p.y>h)p.vy*=-1;
      ctx.beginPath(); ctx.fillStyle=`hsla(${p.hue},80%,70%,.7)`; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }
    requestAnimationFrame(step) }
  step(); addEventListener('resize',()=>{w=innerWidth;h=innerHeight;c.width=w;c.height=h;});
})();

/* core refs */
const big=document.getElementById('big'), file=document.getElementById('file'), statusEl=document.getElementById('status');
const modal=document.getElementById('modal'), fade=document.getElementById('fade');
const outRS=document.getElementById('outRS'), outBH=document.getElementById('outBH');
const copyRS=document.getElementById('copyRS'), copyBH=document.getElementById('copyBH'), closeBtn=document.getElementById('close');
const resetBtn=document.getElementById('reset');
const uploadsEl=document.getElementById('uploads');
const clearFilesBtn=document.getElementById('clearFiles');
const showUUIDBtn=document.getElementById('showUUID');

/* ===== Persistence & Dedup ===== */
const RS_LIST = JSON.parse(localStorage.getItem('RS_LIST') || '[]');
const BH_LIST = JSON.parse(localStorage.getItem('BH_LIST') || '[]');
const PROCESSED_FILES = new Set(JSON.parse(localStorage.getItem('PROCESSED_FILES') || '[]'));

/* พรีวิวไฟล์ที่อัปโหลด (เก็บ packId เพื่อกันซ้ำระดับแอดออน) */
const UPLOADS = JSON.parse(localStorage.getItem('UPLOADS') || '[]'); // [{packId,name,icon,quality}]
function persistAll(){
  localStorage.setItem('RS_LIST', JSON.stringify(RS_LIST));
  localStorage.setItem('BH_LIST', JSON.stringify(BH_LIST));
  localStorage.setItem('PROCESSED_FILES', JSON.stringify(Array.from(PROCESSED_FILES)));
  localStorage.setItem('UPLOADS', JSON.stringify(UPLOADS));
}

/* ——— เคลียร์การ์ดซ้ำที่เคยเซฟทับชื่อเดียวกัน (เก็บใบแรกไว้) ——— */
(function dedupeUploadsByName(){
  if (!Array.isArray(UPLOADS) || !UPLOADS.length) return;
  const seen = new Set();
  for (let i = UPLOADS.length - 1; i >= 0; i--) {
    const key = (UPLOADS[i]?.name || '').replace(/§./g,'').trim().toLowerCase();
    if (seen.has(key)) UPLOADS.splice(i,1);
    else seen.add(key);
  }
  persistAll();
})();

/* Utils */
const fileSig = f => `${f.name}|${f.size}|${f.lastModified}`;
const escRe = (s)=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

function cleanName(n){ return (n||'').replace(/§./g,'').trim(); } // ลบ § และตัวถัดไป

/* UI bindings */
big.addEventListener('click',()=>file.click());
['dragenter','dragover'].forEach(ev=>big.addEventListener(ev,e=>{e.preventDefault();big.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>big.addEventListener(ev,e=>{e.preventDefault();big.classList.remove('drag');}));
big.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
file.onchange=()=>handleFiles(file.files);

/* Show UUID modal */
showUUIDBtn.onclick=()=>openModal();

function isZipLike(n,t){n=(n||'').toLowerCase();return t==='application/zip'||/\.(zip|mcpack|mcaddon)$/.test(n)}
function setLoading(on){statusEl.innerHTML=on?'<span class="spin"></span>กำลังประมวลผล…':''}

function listTopLevelDirs(zip){
  const set=new Set();
  for(const name of Object.keys(zip.files)){
    const m = name.match(/^([^/]+)\/(.+)/);
    if(m) set.add(m[1]+'/');
  }
  return [...set];
}
function dirHasTextures(zip, dirPrefix){
  const re = new RegExp('^'+escRe(dirPrefix)+'textures/','i');
  return Object.keys(zip.files).some(name => re.test(name));
}
function findManifestInDir(zip, dirPrefix){
  const candidates = Object.keys(zip.files).filter(name =>
    new RegExp('^'+escRe(dirPrefix)+'([^/]+/)*manifest\\.json$','i').test(name)
  );
  if(candidates.length===0) return null;
  candidates.sort((a,b)=>a.split('/').length - b.split('/').length);
  return candidates[0];
}
function findAnyManifest(zip){
  const ent = Object.values(zip.files).find(x=>/(^|\/)manifest\.json$/i.test(x.name));
  return ent ? ent.name : null;
}
function hasTexturesInZip(zip, manifestPath){
  const base = manifestPath.includes('/') ? manifestPath.split('/').slice(0,-1).join('/')+'/' : '';
  const re = new RegExp('^'+base.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'textures/','i');
  return Object.keys(zip.files).some(name => re.test(name));
}

/* หา icon ในโฟลเดอร์แพ็ก */
function findIconPath(zip, basePrefix){
  const names = Object.keys(zip.files);
  const reBase = '^'+escRe(basePrefix);
  const candidates = [
    new RegExp(reBase+'pack_icon\\.png$', 'i'),
    new RegExp(reBase+'pack_icon\\.jpg$', 'i'),
       new RegExp(reBase+'pack_icon\\.jpeg$', 'i'),
    new RegExp(reBase+'textures/pack_icon\\.png$', 'i'),
  ];
  for(const rx of candidates){
    const p = names.find(n => rx.test(n));
    if(p) return p;
  }
  const near = names.find(n => new RegExp(reBase+'[^/]*pack.*\\.(png|jpg|jpeg)$','i').test(n));
  return near || null;
}

async function toDataURLFromZip(zip, path){
  const ext = (path.split('.').pop()||'png').toLowerCase();
  const mime = ext==='jpg'||ext==='jpeg' ? 'image/jpeg' : 'image/png';
  const b64 = await zip.file(path).async('base64');
  return `data:${mime};base64,${b64}`;
}

/* ===== ปุ่มลบรายการในการ์ด ===== */
function deleteUpload(index){
  if(index < 0 || index >= UPLOADS.length) return;

  // ลบรายการที่เลือกออกจากอาร์เรย์ UPLOADS
  const removed = UPLOADS.splice(index, 1)[0];

  // ถ้ามี packId → ลบ UUID ที่เกี่ยวข้องทั้ง RS และ BH
  if (removed && removed.packId){
    const pid = String(removed.packId);

    // ลบทุกเวอร์ชันของแอดออนนี้ใน RS_LIST
    for (let i = RS_LIST.length - 1; i >= 0; i--){
      if (String(RS_LIST[i].pack_id) === pid){
        RS_LIST.splice(i, 1);
      }
    }

    // ลบทุกเวอร์ชันของแอดออนนี้ใน BH_LIST
    for (let i = BH_LIST.length - 1; i >= 0; i--){
      if (String(BH_LIST[i].pack_id) === pid){
        BH_LIST.splice(i, 1);
      }
    }

    // รีเซ็ตชุดกันซ้ำ (SEEN_PACKS) ให้ตรงกับข้อมูลใหม่
    if (window.SEEN_PACKS){
      window.SEEN_PACKS = new Set([
        ...RS_LIST.map(p => `RS|${p.pack_id}|${Array.isArray(p.version)?p.version.join('.'):p.version}`),
        ...BH_LIST.map(p => `BH|${p.pack_id}|${Array.isArray(p.version)?p.version.join('.'):p.version}`),
      ]);
    }
  }

  // เซฟลง localStorage และรีเฟรช UI
  persistAll();
  renderUploads();

  // แสดงสถานะชั่วคราว
  statusEl.textContent = 'ลบแล้ว และล้าง UUID ทั้ง RS/BH';
  setTimeout(()=>statusEl.textContent='',1500);
}


/* เรนเดอร์แกลเลอรี่ (เพิ่มปุ่มลบ X) */
function renderUploads(){
  uploadsEl.innerHTML = '';
  if(!UPLOADS.length){ uploadsEl.style.display='none'; return; }
  uploadsEl.style.display='grid';
  UPLOADS.forEach((u,i)=>{
    const card=document.createElement('div');card.className='card';

    const del=document.createElement('button');
    del.className='del'; del.type='button'; del.title='ลบรายการนี้'; del.setAttribute('aria-label','ลบรายการนี้');
    del.innerHTML='<span>×</span>';
    del.onclick=(ev)=>{ev.stopPropagation();deleteUpload(i);};
    del.onkeydown=(ev)=>{if(ev.key==='Enter'||ev.key===' '){ev.preventDefault();deleteUpload(i);}};

    const img=document.createElement('img');img.className='thumb';img.alt=u.name||'pack';img.src=u.icon||'';
    const name=document.createElement('div');name.className='name';name.textContent=u.name||'ไม่ทราบชื่อ';

    card.appendChild(del);
    card.appendChild(img);
    card.appendChild(name);
    uploadsEl.appendChild(card);
  });
}
renderUploads();

/* === แสดงการ์ดเดียวต่อ “ชื่อแอดออน” + อัปเกรดไอคอนถ้าดีกว่า === */
function addUploadEntry(entry){
  // entry: { packId, name, icon, quality }
  if(!entry.packId) return; // ต้องมี uuid ของแพ็ก
  const displayName = cleanName(entry.name);
  const nameKey = displayName.toLowerCase();

  // หาใบที่มีชื่อเดียวกันอยู่แล้วไหม
  const idx = UPLOADS.findIndex(x => cleanName(x.name).toLowerCase() === nameKey);

  if (idx >= 0) {
    // มีแล้ว → อัปเกรดถ้าใบใหม่ดีกว่า (เช่น RS มีไอคอน/คุณภาพสูงกว่า)
    const cur = UPLOADS[idx];
    const curQ = Number(cur.quality||0);
    const newQ = Number(entry.quality||0);
    const shouldUpgrade =
      (newQ > curQ) || (!cur.icon && entry.icon); // ไร้ไอคอนเดิม แต่ใหม่มี
    if (shouldUpgrade) {
      UPLOADS[idx] = { packId: entry.packId, name: displayName, icon: entry.icon||cur.icon||'', quality: newQ||curQ };
      persistAll(); renderUploads();
    }
    return; // ไม่เพิ่มใบใหม่
  }

  // ยังไม่มีชื่อซ้ำ → เพิ่มการ์ด
  UPLOADS.push({ packId: entry.packId, name: displayName, icon: entry.icon||'', quality: entry.quality||0 });
  persistAll();
  renderUploads();
}

/* จัดการไฟล์เข้า */
async function handleFiles(list){
  let files = Array.from(list||[]);
  if (!files.length) return;

  files = files.filter(f => {
    const s = fileSig(f);
    if (PROCESSED_FILES.has(s)) return false;
    PROCESSED_FILES.add(s);
    return true;
  });

  if (files.length === 0) { openModal(); return; }

  fade.className='fadecover show';
  await new Promise(r=>setTimeout(r,180));
  setLoading(true);

  for(const f of files){
    try{
      if(/manifest\.json$/i.test(f.name)){
        const t=await f.text();
        const manifest = await parseManifestText(t);
        await handleManifest(manifest, false);
      }else if(isZipLike(f.name,f.type)){
        const zip=await JSZip.loadAsync(f);
        const topDirs = listTopLevelDirs(zip);
        if(topDirs.length>=1){
          for(const dir of topDirs){
            const manifestPath = findManifestInDir(zip, dir);
            if(!manifestPath) continue;
            const text = await zip.file(manifestPath).async('text');
            const manifest = await parseManifestText(text);
            const isRS = dirHasTextures(zip, dir);
            await handleManifest(manifest, isRS);

            const packId = String(manifest?.header?.uuid || manifest?.header?.pack_id || '');
            const iconPath = findIconPath(zip, dir);
            if(packId && iconPath){
              const dataUrl = await toDataURLFromZip(zip, iconPath);
              const name = (manifest?.header?.name)||dir.replace(/\/$/,'');
              addUploadEntry({ packId, name, icon:dataUrl, quality: isRS?2:1 });
            }
          }
        }else{
          const manifestPath = findAnyManifest(zip);
          if(manifestPath){
            const text = await zip.file(manifestPath).async('text');
            const manifest = await parseManifestText(text);
            const isRS = hasTexturesInZip(zip, manifestPath);
            await handleManifest(manifest, isRS);

            const base = manifestPath.includes('/') ? manifestPath.split('/').slice(0,-1).join('/')+'/' : '';
            const packId = String(manifest?.header?.uuid || manifest?.header?.pack_id || '');
            const iconPath = base ? findIconPath(zip, base) : null;
            if(packId && iconPath){
              const dataUrl = await toDataURLFromZip(zip, iconPath);
              const name = (manifest?.header?.name)|| (base || f.name);
              addUploadEntry({ packId, name, icon:dataUrl, quality: isRS?2:1 });
            }
          }
        }
      }
    }catch{}
  }

  persistAll();

  setLoading(false);
  fade.className='fadecover hide';
  setTimeout(()=>{ fade.className='fadecover'; openModal(); }, 340);
}

async function parseManifestText(text){
  try{return JSON.parse(text);}catch{
    try{
      const fixed=text.replace(/^\s*"|"\s*$/g,'').replace(/\\n/g,'\\n');
      return JSON.parse(JSON.parse('"'+fixed.replace(/"/g,'\\"')+'"'));
    }catch{ return {}; }
  }
}
async function handleManifest(obj, isRS){
  const h=obj?.header||{}; const uuid=h.uuid||h.pack_id; const ver=h.version||h.pack_version;
  if(!uuid||!ver) return;
  const pack_id=String(uuid);
  const version=Array.isArray(ver)?ver.map(Number):String(ver).split('.').map(Number);
  const key = `${isRS?'RS':'BH'}|${pack_id}|${Array.isArray(version)?version.join('.'):version}`;

  if(!window.SEEN_PACKS){
    window.SEEN_PACKS = new Set([
      ...RS_LIST.map(p => `RS|${p.pack_id}|${Array.isArray(p.version)?p.version.join('.'):p.version}`),
      ...BH_LIST.map(p => `BH|${p.pack_id}|${Array.isArray(p.version)?p.version.join('.'):p.version}`),
    ]);
  }
  if (window.SEEN_PACKS.has(key)) return;
  window.SEEN_PACKS.add(key);

  const item={pack_id,version};
  if(isRS) RS_LIST.push(item); else BH_LIST.push(item);
}

/* ===== ทำให้ version อยู่บรรทัดเดียว ===== */
function buildJSON(){
  const fmt = (arr) => {
    const pretty = JSON.stringify(arr, null, 2);
    return pretty.replace(/("version"\s*:\s*)\[\s*([\s\d,]+?)\s*\]/g, (_, p1, nums) => {
      const parts = nums.split(',').map(s=>s.trim()).filter(Boolean);
      return `${p1}[${parts.join(', ')}]`;
    });
  };
  return { rs: fmt(RS_LIST), bh: fmt(BH_LIST) };
}
async function typeOut(el,text){el.textContent='';const d=5;for(let i=0;i<text.length;i++){el.textContent+=text[i];if(i%3===0) await new Promise(r=>setTimeout(r,d));}}
function openModal(){const {rs,bh}=buildJSON(); modal.classList.add('open'); typeOut(outRS,rs); typeOut(outBH,bh);}
closeBtn.onclick=()=>modal.classList.remove('open');

async function copy(t){try{await navigator.clipboard.writeText(t);}catch{}}
copyRS.onclick=()=>copy(outRS.textContent);
copyBH.onclick=()=>copy(outBH.textContent);

/* ปุ่ม “ล้างรายการ” (ในโมดัล) */
resetBtn.onclick=(()=>{
  const clearAll=()=>{
    RS_LIST.length=0; BH_LIST.length=0;
    if(window.SEEN_PACKS) window.SEEN_PACKS.clear();
    PROCESSED_FILES.clear?.(); // เผื่อยังอยู่จากเวอร์ชันก่อน
    UPLOADS.length=0;
    persistAll();
    outRS.textContent='[]'; outBH.textContent='[]';
    renderUploads();
  };
  return clearAll;
})();

/* ปุ่ม “ล้างไฟล์” (ข้างปุ่มใหญ่) — ให้ทำงานเหมือน “ล้างรายการ” */
clearFilesBtn.onclick=()=>{
  resetBtn.onclick();
  statusEl.textContent='ล้างข้อมูลทั้งหมดแล้ว';
  setTimeout(()=>statusEl.textContent='',1500);
};

/* ---------- Inline Service Worker (offline-first) ---------- */
(async () => {
  if (!('serviceWorker' in navigator)) return;
  try {
    const swCode = `
      const CACHE = 'uuid-extractor-v1';
      const ASSETS = [
        './',
        self.location.href,
        'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js',
      ];
      self.addEventListener('install', (e) => {
        e.waitUntil(
          caches.open(CACHE)
            .then(c => c.addAll(ASSETS))
            .then(() => self.skipWaiting())
        );
      });
      self.addEventListener('activate', (e) => {
        e.waitUntil(
          caches.keys()
            .then(keys => Promise.all(keys.map(k => k !== CACHE && caches.delete(k))))
            .then(() => self.clients.claim())
        );
      });
      self.addEventListener('fetch', (e) => {
        const { request } = e;
        e.respondWith(
          caches.match(request).then(cached => cached || fetch(request).then(resp => {
            const copy = resp.clone();
            caches.open(CACHE).then(c => c.put(request, copy)).catch(()=>{});
            return resp;
          }).catch(()=>cached))
        );
      });
    `.trim();

    const blob = new Blob([swCode], { type: 'text/javascript' });
    const swUrl = URL.createObjectURL(blob);
    await navigator.serviceWorker.register(swUrl);
  } catch (err) {
    console.warn('SW register failed:', err);
  }
})();
</script>
</body>
</html>
